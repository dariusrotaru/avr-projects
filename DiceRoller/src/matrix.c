#include <avr/io.h>
#include <stdint.h>
#include <avr/pgmspace.h>
#include <avr/delay.h>
#include "matrix.h"

static const uint8_t rowPins[8] = {PB2, PB3, PB4, PB5, PC0, PC1, PC2, PC3};
static volatile uint8_t* const rowPorts[8] = {&PORTB, &PORTB, &PORTB, &PORTB, &PORTC, &PORTC, &PORTC, &PORTC,};

static const uint8_t colPins[8] = {PD2, PD3, PD4, PD5, PD6, PD7, PB0, PB1};
static volatile uint8_t* const colPorts[8] = {&PORTD, &PORTD, &PORTD, &PORTD, &PORTD, &PORTD, &PORTB, &PORTB};

static uint8_t gCurrentPattern[8];
static uint8_t gCurrentScanRow = 0;

//digits LUT
static const uint8_t digits[28][8] PROGMEM= {
  // 0
  {
    0b00000000,
    0b00011000,
    0b00100100,
    0b00100100,
    0b00100100,
    0b00100100,
    0b00011000,
    0b00000000
  },
  //1
  {
    0b00000000,
    0b00001000,
    0b00011000,
    0b00001000,
    0b00001000,
    0b00001000,
    0b00001000,
    0b00000000
  },
  //2
  {
    0b00000000,
    0b00011100,
    0b00000100,
    0b00011100,
    0b00010000,
    0b00011100,
    0b00000000,
    0b00000000
  },
  //3
  {
    0b00000000,
    0b00011100,
    0b00000100,
    0b00011100,
    0b00000100,
    0b00011100,
    0b00000000,
    0b00000000
  },
  //4
  {
    0b00000000,
    0b00001000,
    0b00011000,
    0b00101000,
    0b01111100,
    0b00001000,
    0b00001000,
    0b00000000
  },
  //5
  {
    0b00000000,
    0b00111000,
    0b00100000,
    0b00111000,
    0b00001000,
    0b00111000,
    0b00000000,
    0b00000000
  },
  //6
  {
    0b00000000,
    0b00111000,
    0b00100000,
    0b00111000,
    0b00101000,
    0b00111000,
    0b00000000,
    0b00000000
  },
  //7
  {
    0b00000000,
    0b00111000,
    0b00001000,
    0b00001000,
    0b00001000,
    0b00001000,
    0b00000000,
    0b00000000
  },
  //8
  {
    0b00000000,
    0b00011000,
    0b00100100,
    0b00100100,
    0b00011000,
    0b00100100,
    0b00011000,
    0b00000000
  },
  //9
  {
    0b00000000,
    0b00011100,
    0b00010100,
    0b00011100,
    0b00000100,
    0b00000100,
    0b00011100,
    0b00000000
  },
  //10
  {
    0b00000000,
    0b00100110,
    0b01101001,
    0b00101001,
    0b00101001,
    0b00101001,
    0b00100110,
    0b00000000
  },
  //11
  {
    0b00000000,
    0b00100100,
    0b01101100,
    0b00100100,
    0b00100100,
    0b00100100,
    0b00100100,
    0b00000000
  },
  //12
  {
    0b00000000,
    0b00101110,
    0b01100010,
    0b00100010,
    0b00101110,
    0b00101000,
    0b00101110,
    0b00000000
  },
  //13
  {
    0b00000000,
    0b00101110,
    0b01100010,
    0b00100010,
    0b00101110,
    0b00100010,
    0b00101110,
    0b00000000
  },
  //14
  {
    0b00000000,
    0b00100010,
    0b01100110,
    0b00101010,
    0b00101111,
    0b00100010,
    0b00100010,
    0b00000000
  },
  //15
  {
    0b00000000,
    0b00101110,
    0b01101000,
    0b00101110,
    0b00100010,
    0b00100010,
    0b00101110,
    0b00000000
  },
  //16
  {
    0b00000000,
    0b00101110,
    0b01101000,
    0b00101110,
    0b00101010,
    0b00101010,
    0b00101110,
    0b00000000
  },
  //17
  {
    0b00000000,
    0b00101110,
    0b01100010,
    0b00100010,
    0b00100010,
    0b00100010,
    0b00100010,
    0b00000010
  },
  //18
  {
    0b00000000,
    0b00100110,
    0b01101001,
    0b00101001,
    0b00100110,
    0b00101001,
    0b00100110,
    0b00000000
  },
  //19
  {
    0b00000000,
    0b00101110,
    0b01101010,
    0b00101110,
    0b00100010,
    0b00100010,
    0b00101110,
    0b00000000
  },
  //20
  {
    0b00000000,
    0b11100110,
    0b00101001,
    0b00101001,
    0b11101001,
    0b10001001,
    0b11100110,
    0b00000000
  },
  //21 / p1
  {
    0b00000000,
    0b00000000,
    0b00000000,
    0b00011000,
    0b00011000,
    0b00000000,
    0b00000000,
    0b00000000
  },
  //22 / p2
  {
    0b00000000,
    0b00000000,
    0b00111100,
    0b00100100,
    0b00100100,
    0b00111100,
    0b00000000,
    0b00000000
  },
  //23 / p3
  {
    0b00000000,
    0b01111110,
    0b01000010,
    0b01000010,
    0b01000010,
    0b01000010,
    0b01111110,
    0b00000000
  },
  //24 / p4
  {
    0b11111111,
    0b10000001,
    0b10000001,
    0b10000001,
    0b10000001,
    0b10000001,
    0b10000001,
    0b11111111
  },
  //25 / crit failure
  {
    0b00000000,
    0b01010101,
    0b00100010,
    0b01010101,
    0b00000000,
    0b00011100,
    0b00100010,
    0b00000000
  },
  //26 / crit success
  {
    0b00000000,
    0b00110110,
    0b01001001,
    0b01000001,
    0b01000001,
    0b00100010,
    0b00010100,
    0b00001000
  },
  //27 / GO
  {
    0b00000000,
    0b11110110,
    0b10001001,
    0b10001001,
    0b11111001,
    0b10011001,
    0b11110110,
    0b00000000
  }
};

// initiating pins
void MatrixInit(void) {
    DDRB |= (1 << PB0) | (1 << PB1) | (1 << PB2) | (1 << PB3) | (1 << PB4) | (1 << PB5);
    DDRC |= (1 << PC0) | (1 << PC1) | (1 << PC2) | (1 << PC3);
    DDRD |= (1 << PD2) | (1 << PD3) | (1 << PD4) | (1 << PD5) | (1 << PD6) | (1 << PD7);
    PORTC |= (1 << PC5);
}

// load pattern from progmem into ram buffer
void MatrixLoadPattern(uint8_t index){
  if(index >= 28) index = 0;
  for(uint8_t i = 0; i < 8; i++){
    gCurrentPattern[i] = pgm_read_byte(&digits[index][i]);
  }
}
// matrix display function

void MatrixUpdate(void){
  *rowPorts[gCurrentScanRow] &= ~(1 <<rowPins[gCurrentScanRow]);
  gCurrentScanRow = (gCurrentScanRow + 1) % 8;
  uint8_t rowPattern = gCurrentPattern[gCurrentScanRow];
  PORTD |= 0xFF;
  PORTB |= 0x03;

  for(uint8_t j = 0; j < 8; j++){
    if((rowPattern >> (7 - j)) & 1){
      *colPorts[j] &= ~(1 << colPins[j]);
    }
  }
  *rowPorts[gCurrentScanRow] |= (1 << rowPins[gCurrentScanRow]);
}